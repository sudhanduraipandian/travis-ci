dist: trusty
language: cpp
compiler:
  - gcc
  - clang
env:
  global:
    - OSM2GO_BUILD_DIR=/tmp/osm2go-cdash
    - VALGRIND_SUPP_DIR=/tmp/valgrind-suppressions
  matrix:
    - BUILD_NAME="default" CONF_OPTIONS="CONF_OPTIONS=-DUSE_SVG_ICONS=On;-DNETWORK_TESTS=On"
    - BUILD_NAME="picker" CONF_OPTIONS="CONF_OPTIONS=-DSERVER_EDITABLE=Off;-DPICKER_MENU=On;-DUSE_SVG_ICONS=Off;-DNETWORK_TESTS=On" CURL_VERSION="7.61.1"
cache:
  directories:
  - $VALGRIND_SUPP_DIR
addons:
  apt:
    packages:
    - libgoocanvas-dev
    - libcurl4-openssl-dev
    - libsoup2.4-dev
    - libgps-dev
    - libgtk2.0-dev
    - libgnomevfs2-dev
    - lcov
    - valgrind
script:
  # fix pc file, see https://savannah.nongnu.org/bugs/?51894
  - mkdir /tmp/fix-pc
  - cp $(find /usr/lib* -name libgps.pc) /tmp/fix-pc
  - sed 's#}/usr#}#' -i /tmp/fix-pc/libgps.pc
  - export PKG_CONFIG_PATH=/tmp/fix-pc:${PKG_CONFIG_PATH}

  - if [ ! -s ${VALGRIND_SUPP_DIR}/valgrind-auto.supp ]; then mkdir -p ${OSM2GO_BUILD_DIR} ${VALGRIND_SUPP_DIR}; pushd ${OSM2GO_BUILD_DIR}; cmake -D CMAKE_BUILD_TYPE=Debug ${TRAVIS_BUILD_DIR}; make suppression-dummy; valgrind --leak-check=full --gen-suppressions=all --show-leak-kinds=all ./test/suppression-dummy 2>&1 | grep -v '^=' > ${VALGRIND_SUPP_DIR}/valgrind-auto.supp; popd; fi

  - if [ -n "${CURL_VERSION}" ]; then wget -O - https://curl.haxx.se/download/curl-${CURL_VERSION}.tar.xz | tar xJ; mv curl-${CURL_VERSION} curl; sed '/^message(WARNING "the curl cmake build system is poorly maintained. Be aware")$/d' -i curl/CMakeLists.txt; fi

  - echo -e "set(OSM2GO_BUILD_DIR \"${OSM2GO_BUILD_DIR}\")\nset(dashboard_model \"Continuous\")\nset(CTEST_SITE travis-ci.org)\nset(CTEST_BUILD_NAME \"CI ${CC} ${BUILD_NAME}\")\nset(CTEST_MEMORYCHECK_COMMAND_OPTIONS \"--suppressions=${VALGRIND_SUPP_DIR}/valgrind-auto.supp\")\ninclude(${TRAVIS_BUILD_DIR}/ctest_osm2go.cmake)" > my_osm2go.cmake
  - CFLAGS="-O0 -fprofile-arcs -ftest-coverage" CXXFLAGS="-O0 -fprofile-arcs -ftest-coverage" ctest -V -S my_osm2go.cmake -D "${CONF_OPTIONS}"|| true
after_success:
  - lcov --directory ${OSM2GO_BUILD_DIR} --capture --output-file coverage.info # capture coverage info
  - lcov --remove coverage.info '/usr/*' "${TRAVIS_BUILD_DIR}/curl/*" --output-file coverage.info # filter out system
  - lcov --list coverage.info #debug info
  - bash <(curl -s https://codecov.io/bash)
