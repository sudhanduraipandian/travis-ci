# .travis.yml

language: c

cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store
    - $HOME/build/opensuse-haskell/configuration/_build

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx

addons:
  apt:
    sources:
      - hvr-ghc
    packages:
      - ghc-ppa-tools
      - cabal-install-2.4
      - ghc-8.6.3
      - rpm

before_install:
  - unset CC
  - export PATH=$HOME/.local/bin:$HOME/.cabal/bin:/opt/ghc/bin:/opt/cabal/bin:$PATH
  - mkdir -p $HOME/.local/bin

install:
  - python3 --version
  - cabal --version
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - travis_retry cabal update
  - "sed -i 's/^jobs:.*/jobs: 2/' $HOME/.cabal/config"
  - cabal new-install shelltestrunner

script:
  - rm -f _build/*/*/*.changes
  - cabal new-run cabal2obs -- --keep-going -j2 ghc-8.6.x
  - cabal new-test all
  - tests/run-tests
