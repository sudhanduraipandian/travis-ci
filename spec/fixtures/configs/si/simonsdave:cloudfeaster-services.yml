dist: trusty
sudo: required
language: python
python:
  - '2.7'
services:
  - docker
env:
  global:
    - DOCKER_TEMP_TAG=bindle
    - GCLOUD_PROJECT=$(echo "$GCLOUD_SERVICE_ACCOUNT_KEY" | base64 --decode | jq -M -r .project_id)
install:
  # installing ndg-httpsclient eliminates a TLS warning
  # generated by coveralls
  - pip install ndg-httpsclient==0.5.0
  # install and configure GCP sdk
  - rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash
  - source $HOME/google-cloud-sdk/path.bash.inc
  - gcloud --quiet version
  - echo "$GCLOUD_SERVICE_ACCOUNT_KEY" | base64 --decode > ${HOME}/gcloud-service-account-key.json
  - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-account-key.json
  - rm ${HOME}/gcloud-service-account-key.json
  # authenticate to docker hub
  - docker login --username="$DOCKER_USERNAME" --password="$DOCKER_PASSWORD"
  # configure the development environment
  - source cfg4dev
  - pip install coveralls
  - docker pull koalaman/shellcheck:latest
script:
  - flake8
  - pip check
  - docker run -v "$PWD:/mnt" koalaman/shellcheck:latest $(find . -name \*.sh | grep -v \.\/env)
  - tor_async_util_nosetests.py --with-coverage --cover-branches --cover-erase --cover-package cloudfeaster_services cloudfeaster_services
  - coveralls || true
  - travis_fold start "build.python.packages"
  - python setup.py bdist_wheel sdist --formats=gztar
  - travis_fold end "build.python.packages"
  - travis_fold start "build.docker.image"
  - ./dockerfiles/build-docker-images.sh "$DOCKER_USERNAME" "$DOCKER_TEMP_TAG" ./dist/cloudfeaster_services-*.*.*.tar.gz
  - travis_fold end "build.docker.image"
  # :TODO: should be some integration testing on the docker images we just built
deploy:
  - provider: script
    script: ./dockerfiles/tag-and-push-docker-images.sh $DOCKER_USERNAME $GCLOUD_PROJECT $DOCKER_TEMP_TAG latest
    on:
      branch: master
  - provider: script
    script: ./dockerfiles/tag-and-push-docker-images.sh $DOCKER_USERNAME $GCLOUD_PROJECT $DOCKER_TEMP_TAG $TRAVIS_TAG
    on:
      tags: true
