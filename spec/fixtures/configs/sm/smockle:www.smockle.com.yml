language: node_js
node_js:
- '8'
cache:
  directories:
  - node_modules
notifications:
  email:
    on_success: change
    on_failure: always
env:
  global:
  - PATH=$HOME/.local/bin:$PATH
  - secure: fDH2TYmtrZk0aWGZAQsf+SwZ2JGQEvf3zyBrMimOSBkD8/F8YChOQd7H1o2W2gpw8+KzNJIleR3AI57Hj8mFrGET6hebKAkz4bn9oMg+AWEAv33pjmhCANqY19Htpx2BKVqS7iogn3DDEV4I1Ab/lUvqEG0oXsNf93PnktGdBteuCSG2tLzC3IOsSFtr0Q204glhPXVv3yvZJ5h9tov7YHfYYoz/pghu/V9HzOhHCfT02ZKQvTZbmT7ryRxxhh8FTznCpq/oDBqGKiKnmIKtBaZC7SIObhiRnZyLvzPuk0EcYBZxzhzxfRZqqcLgF1hoozTxdBpyrzONMjmGC3RHePjOMov6UTmdYlHa2m1hSu/VbvtqaS9zaXMyplTat9YlrpK8JRGUr/tN5q+kDZGOppLssKzhxCH9YtK7kFu/PzFlJ9sqRb4MrwQ/OLZ40/uYj1tgeiOub3VWOBsE1AwXvoDqifXsqziDV+kFNb3eI0MejiQG1hyeDelhZQlGCDSRz6tYvlarjNrfFUg11K/xkRT2xO1oVHw+qoKW9yygR/6yRKyzEu+aE/J0ES919yH3dhx2UlVtjP7xbu5PCRtDiZCaDMaFdSg9XvyUQ3oVfe/wkdhB4cNdemQBMZ9+TTv1slx3gJXm5I1zGxyjDi92MBOquCLIPBjxIFwf6zv6ae4=
  - secure: f95zQQ2wsho4EIgVYAR4PweQaPpXqqPK0dfpsJhvbUnRHRTqgl5dLKDtiKvewNhluEGTZ/M1tw5078SutUf7Rg9rH0mqhh+pn294U391jatWntSUKM8xzGpfnM4RXKZCAWfIbin1/AjlQR8uGGi5tgU1I1tC5GILjoewudU/x7Q/OWIGzUtd5doW8a6YGOVUZled/EKqe34gWxUp6+jXNMM2I/XSfrmzOzd0bfb80RXvXX+yhKJHfjmfLU0F5nBKGDhNzHzCarqJ1mVFu6fwxvVFgMjhy1GfEr3JmONPkPm6roI5XYe/0vhZk4H6aE9N6MXNYLqVvx7Zsm+0LrStsyO/tuMW7viseUknPyOR23IXuoom91uGLFZid0hG4Mn4dft0RN0YOTLB50wuoq5rxel6IFghw+DMR2E8ldDFdIfdIBK0EHH+coqMSOSCedGPDRg3/CHJAYMWgEFiUjEGHJ0npnQEGwQQZ+b1kvYZGeB8hQ86hXFAu2jq87sZYrr7y/4hDTBS9y52r+xGkrem/2HqF6OO+JfWtibiOAkCMTq5KlTlM4ZmZalcM6yjPdhSQvm4pmrGyUntViD7cuRfTo+qs6OB7/2lSFuLqcYhc54tvGw7IQCyHlvrX3Jz4gjjSX4yMofl5RaQBnAwr0Wr7ENQ+XavjfCuE5InoOaYMrg=
  - secure: t5ViL47aeyg65ony7O456pQ6HELD4s1WIKy1JsnZUPYwxEekP8OKXxKb6hY0xfDF2rlISD9nCQoBNGl7PG8Ey2VZUzZ0GbXCtwlxiDHMdcwTPII3m2f+S6vs33JYBhfPrYiJFUIFan3YHWS/QeRs8xSY58xuxDbJmfvMrjBNGIKwvGR44T4i+rhfX35PZjjriVd61ez0By4cbLuGvQQOimXdmb5FVtNUjFK3s6Du4k/y/4KMGPqvZ8mnn+sqJiUBRJ1UBgYJ8GajxI0rt1aLfyCGkBTek+cFeFx0RQlDUjbicrnJHBqY2+sK+8sRHRPArkr+eQYqWRFejYu1FUQDFyWba5hYgifH1xK4SyIDOXC4hC48dOLN3Aa+5QTGUMpmnqk6htkRhz4CZLJBYy+J5sliRdIr4GazYNuylG6nZRo7kspGceiJg5jpr7/BxM5flCbJNtSXqVNNG7eZFZYdwhbpJIu8Ch+DJ3ONeAZMx0SznbQFuP34bR7w+X5eqmtIXTopxge1juDdCNq+sJlpi1HMmqFT4NYupRIU3qfUbStGvcGriRv3AW8pGbffUhEr0IdCCF+P3PtDDV3+8Vhi9ErqI6ZXvPMROnKdSZu/Y1f2Gu85a5ExdkKOKXlTF9kqaRP75zdjzbLjdbOoeBetFrUtSG3WppKKIGfoWLBZ7J8=
  - secure: KjrTrFAOznh1x+w2K2Pa0EH5MdHA+ZI/w5PB9xmEXSlXxYJLRYdNvkrzUJ+nLmXvuOhjXzUy7p26CKfeopsg0OIRZMFQtWOLljrPG9JOS2xWvo9sERYqAf+Al7gxVOWZd9C9ayLlxl3ZualFhJjryGI8cNkmM3aBBUQVH0aCBX6pxNnWF6Pclso8pe7632vlHz9jVHYD+I88Y69pOfnmzsF3GPst3Yq3EVZoM9YByPJ8CmsEnXGRx8+hiTrFArnTPml/Olfg+mn5srz+ULE4Roe+sVg4D+XJQEr2G0AG92bn2+S1sjDA9JhNI/oitETXBNik1POLeAuYF9+qYqjf5x2VY9mwI69h31Ax1ztaQOqVQ319Jv/zZcvcVDL1hakwUqMX9Iz1apmtjHYyFdFCyQ9UsLk9I9kroxgTW50yrQ3iCvX1GH8TBCzO5ILG0LUaCyQbA9my+sHFP4YZCFZo/O0+mCXDOuciSvjwqP+wrSy3BIYESPL7PpR4Vww1SWyjVQcx87PO5ulM7FfgDuYqYWatESzplbdlYu5F954/jUzv+lHUEtlRBVXtzh8NY5v+rjA/A/CvUGOIRMXOWvyz04kcraVWQwGzgsoozp4sUtODgrkt/KdQBnMihzqMtQyyHMbfTmToI52QbxLJTBRbrDCfNRms0ALDWC3ChjSaTZo=
stages:
- unit tests
- name: deploy to staging
  if: branch = master
- name: test staging
  if: branch = master
- name: deploy to production
  if: branch = master
- name: test production
  if: branch = master
jobs:
  include:
  - stage: unit tests
    before_script: npm run build
    script: npm test
  - stage: deploy to staging
    before_script: npm run build
    script: skip
    before_deploy: pip install --user awscli
    deploy:
    - provider: script
      script: npm run deploy:staging
      skip_cleanup: true
      on:
        branch: master
  - stage: test staging
    script: npm run test:staging
  - stage: deploy to production
    script: skip
    before_deploy: pip install --user awscli
    deploy:
    - provider: script
      script: npm run promote
      skip_cleanup: true
      on:
        branch: master
  - stage: test production
    script: npm run test:production
